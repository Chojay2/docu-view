// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum DatasetStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      UserRole @default(USER)
  name      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  submittedDatasets    Dataset[]           @relation("DatasetSubmitter")
  createdProjects      Project[]
  submittedSubmissions DatasetSubmission[] @relation("SubmissionSubmitter")
  reviewedSubmissions  DatasetSubmission[] @relation("SubmissionReviewer")

  @@map("users")
}

model Dataset {
  id                    String        @id @default(cuid())
  slug                  String        @unique
  title                 String
  description           String?       @db.Text
  category              String
  tags                  String[]
  license               String
  sourceOrg             String        @map("source_org")
  ownerUserId           String?       @map("owner_user_id")
  submittedBy           String?       @map("submitted_by")
  status                DatasetStatus @default(DRAFT)
  updateFrequency       String        @map("update_frequency")
  spatialCoverage       Json?         @map("spatial_coverage")
  temporalCoverageStart DateTime?     @map("temporal_coverage_start")
  temporalCoverageEnd   DateTime?     @map("temporal_coverage_end")
  dataFormat            String[]      @map("data_format")
  previewSchema         Json?         @map("preview_schema")
  isPublic              Boolean       @default(false) @map("is_public")
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  resources   DatasetResource[]
  projects    ProjectDataset[]
  submissions DatasetSubmission[]
  schema      DatasetSchema?
  submitter   User?               @relation("DatasetSubmitter", fields: [submittedBy], references: [id])

  @@map("datasets")
}

model DatasetResource {
  id           String   @id @default(cuid())
  datasetId    String   @map("dataset_id")
  resourceType String   @map("resource_type")
  storageUrl   String?  @map("storage_url")
  apiEndpoint  String?  @map("api_endpoint")
  fileFormat   String?  @map("file_format")
  size         BigInt?
  hash         String?
  version      String   @default("1.0.0")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  dataset Dataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@map("dataset_resources")
}

model Project {
  id        String        @id @default(cuid())
  title     String
  abstract  String?       @db.Text
  linkType  String        @map("link_type")
  linkUrl   String        @map("link_url")
  authors   String[]
  tags      String[]
  status    DatasetStatus @default(APPROVED)
  createdBy String?       @map("created_by")
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  datasets ProjectDataset[]
  creator  User?            @relation(fields: [createdBy], references: [id])

  @@map("projects")
}

model DatasetSubmission {
  id          String           @id @default(cuid())
  datasetId   String           @map("dataset_id")
  submittedBy String           @map("submitted_by")
  status      SubmissionStatus @default(PENDING)
  adminNotes  String?          @map("admin_notes") @db.Text
  reviewedBy  String?          @map("reviewed_by")
  submittedAt DateTime         @default(now()) @map("submitted_at")
  reviewedAt  DateTime?        @map("reviewed_at")

  dataset   Dataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  submitter User    @relation("SubmissionSubmitter", fields: [submittedBy], references: [id])
  reviewer  User?   @relation("SubmissionReviewer", fields: [reviewedBy], references: [id])

  @@map("dataset_submissions")
}

model DatasetSchema {
  id        String   @id @default(cuid())
  datasetId String   @unique @map("dataset_id")
  fields    Json // Array of { name, type, description, required }
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  dataset Dataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@map("dataset_schemas")
}

model ProjectDataset {
  id        String   @id @default(cuid())
  projectId String   @map("project_id")
  datasetId String   @map("dataset_id")
  createdAt DateTime @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  dataset Dataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@unique([projectId, datasetId])
  @@map("project_datasets")
}
